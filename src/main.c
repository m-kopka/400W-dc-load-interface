#include "common_defs.h"
#include "hal/xosc.h"
#include "hal/pll.h"
#include "hal/clocks.h"
#include "hal/fc0.h"
#include "display_driver/display.h"

const uint8_t bitmap_onsemi_logo_92x16[] = {

    92, 16, // bitmap dimensions in pixels
    0xE0, 0xF8, 0xFC, 0x1E, 0x0E, 0x07, 0x07, 0x07, 0x07, 0x07,
    0x07, 0x0E, 0x3E, 0xFC, 0xF8, 0xC0, 0x00, 0xE0, 0xF8, 0xFC,
    0x1E, 0x0F, 0x07, 0x07, 0x07, 0x07, 0x0F, 0x0E, 0xFE, 0xFC,
    0xF8, 0x00, 0x00, 0x38, 0x7E, 0xFE, 0xC7, 0xC7, 0x87, 0x87,
    0x8F, 0x9E, 0x1C, 0x18, 0x00, 0x00, 0xF0, 0xF8, 0xFC, 0xCE,
    0xCE, 0xC7, 0xC7, 0xC7, 0xC7, 0xC6, 0xCE, 0xFC, 0xF8, 0xF0,
    0x80, 0x00, 0xF0, 0xFC, 0xFE, 0x0E, 0x07, 0x07, 0x07, 0x07,
    0x0E, 0xFE, 0xFC, 0xFE, 0x0E, 0x07, 0x07, 0x07, 0x07, 0x0F,
    0xFE, 0xFC, 0xF8, 0x00, 0x00, 0x0F, 0xF3, 0xFC, 0x00, 0x00,
    0x00, 0x00, 0x07, 0x1F, 0x3F, 0x78, 0x70, 0xE0, 0xE0, 0xE0,
    0xE0, 0xE0, 0xE0, 0x70, 0x7C, 0x3F, 0x1F, 0x03, 0x00, 0xFF,
    0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x38, 0x78, 0x70, 0xE1, 0xE1,
    0xE1, 0xE3, 0xE3, 0x7F, 0x7F, 0x3E, 0x00, 0x00, 0x0F, 0x1F,
    0x3D, 0x71, 0x71, 0xE1, 0xE1, 0xE1, 0xE1, 0xE1, 0x71, 0x3D,
    0x3D, 0x0D, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0xFF, 0xFF, 0xFF,
    0x00, 0x00, 0x80, 0x00
};

void blink_task(void);

int main() {

    // enable the crystal oscillator, initialize the PLL and set the system clock source to PLL without glitching the system clock
    xosc_enable();
    clocks_set_source(clk_sys, CLOCK_SRC_ROSC_CLKSRC_PH);
    pll_init(PLL_SYS, 100, 6, 2);
    clocks_set_aux_source(clk_sys, CLOCK_AUXSRC_CLKSRC_PLL_SYS);
    clocks_set_source(clk_sys, CLOCK_SRC_CLKSRC_CLK_REF_AUX);

    // set the XOSC as a reference clock and initialize the frequency counter
    clocks_set_source(clk_ref, CLOCK_SRC_XOSC_CLKSRC);
    fc0_init(F_XOSC_HZ);

    gpio_init();
    
    kernel_init(F_CORE_HZ);
    kernel_create_task(debug_uart_task, 2000);
    kernel_create_task(blink_task, 1000);
    kernel_start();

	while (1) {

        NVIC_SystemReset();
    }
}

void blink_task(void) {

    gpio_write(16, HIGH);
    gpio_set_dir(16, GPIO_DIR_OUTPUT);

    display_init();
    display_draw_bitmap(bitmap_onsemi_logo_92x16, 18, 16);
    display_draw_string("DC Electronic Load", font_6x8, 10, 40, 0);
    display_draw_string("Martin Kopka 2024", font_6x8, 10, 48, 0);
    display_render_frame();

    while (1) {

        gpio_toggle(16);
        kernel_sleep_ms(500);
    }
}

//----------------------------------------------------------------------------------------------------------------------------------------------------------------
